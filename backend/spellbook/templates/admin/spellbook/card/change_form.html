{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    {% include 'admin/spellbook/includes/jquery_imports.html' %}
    <script src="{% static 'admin/js/card_info.js' %}" type="text/javascript"></script>
    <style>
        #card-image {
            width: min(8cm, 100%);
        }
    </style>
{% endblock %}

{% block admin_change_form_document_ready %}
    {{ block.super }}
    <script>
        function updateCardImage() {
            django.jQuery.ajax({
                type: 'POST',
                url: 'https://api.scryfall.com/cards/collection',
                data: JSON.stringify({
                    identifiers: [{
                        oracle_id: document.getElementById('id_oracle_id').value
                    }]
                }),
                success: function(data) {
                    if (data.data.length > 0) {
                        let png_url = data.data[0].image_uris.png;
                        document.getElementById('card-image').src = png_url;
                    }
                },
                contentType: 'application/json',
                dataType: 'json'
            });
        }
        if (document.getElementById('id_oracle_id').value) {
            updateCardImage();
        }
        $('#id_name').autocomplete({
            source: function(request, response) {
                django.jQuery.ajax({
                    url: 'https://api.scryfall.com/cards/autocomplete',
                    dataType: 'json',
                    data: {
                        q: request.term,
                        format: 'json'
                    },
                    success: function(data) {
                        response(data.data);
                    }
                });
            },
            minLength: 3,
            select: function(event, ui) {
                let card = ui.item.value;
                django.jQuery.ajax({
                    url: 'https://api.scryfall.com/cards/named',
                    dataType: 'json',
                    data: {
                        exact: card,
                        format: 'json'
                    },
                    success: function(data) {
                        let oracle_id = data.oracle_id;
                        django.jQuery('#id_oracle_id').val(oracle_id);

                        let color_identity = new Set(Array.from(data.color_identity).map(i => i.toUpperCase()));
                        let result = '';
                        for (const c of 'WUBRG') {
                            if (color_identity.has(c)) {
                                result += c;
                            }
                        }
                        django.jQuery('#id_identity').val(result);
                        updateCardImage();
                    }
                })
            },
            open: function() {},
            close: function() {},
        })
        .autocomplete('instance')
        ._renderItem = function(ul, item) {
            return $("<li>")
                .attr("data-value", item.value)
                .mouseover(function(e) {
                    e.preventDefault();
                    fetch_card_info(item.value, e.target);
                })
                .append(item.label)
                .appendTo(ul);
        };
    </script>
{% endblock %}

{% block after-content %}
    {{ block.super }}
    <table class="after-content">
        <thead>
            <tr>
                <th class="column-variant">Card image from Scryfall</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <img id="card-image" src="{% static 'spellbook/images/card-back.png' %}" alt="'{{ original.name }}' image">
                </td>
            </tr>
        </tbody>
    </table>
    <table class="after-content">
        <thead>
            <tr>
                <th class="column-variant">Used in combos</th>
            </tr>
        </thead>
        <tbody>
            {% for item in original.used_in_combos.all|slice:suggested_slice %}
                <tr class="form-row">
                    <td class="field-combo">
                        <p>
                            <a href="{% url 'admin:spellbook_combo_change' item.id %}">{{ item }}</a>
                        </p>
                    </td>
                </tr>
            {% endfor %}
            {% if original.used_in_combos.count > suggested_count %}
                <tr class="form-row">
                    <td class="field-combo">
                        <p>
                            <a href="{% url 'admin:spellbook_combo_changelist' %}">View more combos...</a>
                        </p>
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
{% endblock %}
